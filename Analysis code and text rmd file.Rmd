---
title: "Analysis code Rmarkdown"
author: "Jannick Akkermans, Sander van Gestel, Lauke Stoel en Annemarie Timmers"
date: "26/11/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages, include=FALSE}
library(dplyr)
library(tidyverse)
```

Set working directory and load data
```{r}
setwd("C:/Users/sande/OneDrive/Documenten/M&S")
dat <- readRDS("covid cases waste + tests.RDS")
```


# DATA CLEANING

Rename column names to include a code for the level of measurement: 
SR = Security Region
MN = Municipality
TP = Treatment Plant

```{r}
dat <- dat %>% rename(SR_code = code, 
                      SR_name = naam,
                      MN_name = Municipality_name, 
                      MN_code = Municipality_code, 
                      MN_province = Province,
                      MN_total.reported = Total_reported, 
                      MN_hospital.admisstions = Hospital_admission, 
                      MN_deceased = Deceased, 
                      MN_pop = inhabitants, 
                      MN_popperkm2 = perkm.2, 
                      MN_sizekm2 = size,
                      TP_code = RWZI_AWZI_code, 
                      TP_name = RWZI_AWZI_name,
                      TP_Xco = X_coordinate,
                      TP_Yco = Y_coordinate, 
                      TP_postal.code = Postal_code, 
                      TP_security.region = Security_region_name, 
                      TP_percentage.in.SR = Percentage_in_security_region,
                      TP_RNA.per.ml = RNA_per_ml, 
                      TP_RNA.flow.per.100000 = RNA_flow_per_100000, 
                      TP_representative.measurement = 
                      Representative_measurement)
```

Re-order the data such that those of the same level of measurement are put together. The date_of_report variable has been left out - it's the same as newdate and newdate has a more convenient notation. 
```{r}
dat <- dat %>% select(newdate, SR_code, SR_name, MN_code, MN_name, MN_code:TP_RNA.per.ml, TP_RNA.flow.per.100000, TP_representative.measurement)
```

Structure of the dataset: 
```{r}
str(dat)
```
Some variables are reported as character strings, that should be numeric variables - such as MN_sizekm2, TP_percentage.in.SR and TP_RNA.flow.per.100000. This is because the Dutch notation for decimal numbers is comma's, where R would expect dots, and vice versa. Other variables are noted in the wrong order of size because of this. 
```{r}
#replace comma's by dots for all variables with decimals
dat$MN_sizekm2 <- gsub(",", ".", dat$MN_sizekm2)
dat$MN_popperkm2 <- gsub(",", ".", dat$MN_popperkm2)
dat$TP_percentage.in.SR <- gsub(",", ".", dat$TP_percentage.in.SR)
dat$TP_RNA.flow.per.100000 <- gsub(",", ".", dat$TP_RNA.flow.per.100000)

#multiply by 1000 to get rid of the "." in the population variable
dat <- dat %>% mutate(MN_pop = MN_pop*1000)

#redefine variables as numeric:
dat$TP_Yco <- as.numeric(dat$TP_Yco)
dat$MN_popperkm2 <- as.numeric(dat$MN_popperkm2)
dat$MN_sizekm2 <- as.numeric(dat$MN_sizekm2)
dat$TP_RNA.flow.per.100000 <- as.numeric(dat$TP_RNA.flow.per.100000)
dat$TP_percentage.in.SR <- as.numeric(dat$TP_percentage.in.SR)

#check the structure again
str(dat)
```


# Introduction

In December 2019, a virus known as SARS-Cov-2 (COVID-19) was identified in Wuhan, China. This new variant of the SARS coronavirus caused a worldwide pandemic with far-reaching consequences. An important factor contributing to the silent spread of the virus is the fact that 20 to 40% of the patients show no symptoms, (Vallejo et al., 2019).

Although patients do not always show symptoms of the virus, they often do excrete RNA particles of the virus in their faeces as shown by for example Pan et al. (2020). The virus can sustain itself for a long period within the faeces, in some cases even for one or more months after the respective patient has tested negative for COVID-19 in their respiratory samples (Vallejo et al., 2019). Therefore, the amount of RNA particles could be a valuable indicator of the true number of COVID-19 patients within a country or municipality. 
The aim of this project is to estimate the true number of infected people in the Netherlands based on amount of RNA particles in sewage water. 


# Related work / literature review

## Data and methodology

### Structure of the data
We are working with two datasets, both collected by the Dutch National Institute for Public Health and the Environment (RIVM). The first dataset contains the total number of positive tests reported per day per municipality. It also contains information on key characteristics of the municipality, such as population density and which security region it is part of. The second dataset contains data recorded on the level of sewage treatment plants. The key variable here is the average concentration of SARS-CoV-2 RNA measured in the daily amount of sewage water per 100,000 inhabitants. This dataset also contains crucial metadata of the sewage treatment plants, such as in which security region the area of responsibility of this treatment plant falls. The two datasets were matched to each other by the variable in which security region a municipality and a treatment plant’s area fall respectively.

### Challenges in the data

Our goal is to estimate the true number of COVID-19 patients at any given day, based on the data we have available describing the RNA flow in the sewage water. To do this, we first have to establish if there is a relationship between the RNA flow and the number of positive tests per day. Given the data structure, we are faced with a few challenges before we can take on this question.
First of all, the data on the number of positive tests are recorded on the level of municipalities, whereas the data on RNA flow are recorded on the treatment plant level. In the most straightforward cases, we can aggregate the RNA flow data to municipality level data by virtue that the datasets were already matched by security region code. See SR1 of Figure 1.

However, some sewage treatment plants also treat water from outside their primary security region, creating double entries in the dataset and making simple matching impossible. Luckily, the dataset also provides information on what percentage of the water a treatment plant processes comes from which security region, so we can weight the RNA flow by this variable. See SR2 of Figure 1.
Furthermore, some very large municipalities produce so much sewage water in one day, that multiple treatment plants are required to process it, causing a second kind of double entries. See SR3 of Figure 1. Unfortunately, there are no data available that specify how much of the water from these large municipalities goes to which treatment plant, making it impossible to establish if there is a relationship between the RNA flow and the number of positive cases on the municipality level.

We take the above relationships into account in our analyses. Furthermore, we conclude that we have to aggregate our data to the Security Region level when establishing a relationship between RNA flow and number of positive cases, to get an accurate indicator. Lastly, the data we use in our analyses are a subset of the original dataset, because the dataset only includes all sewage treatment plants from the 7th of September onwards. 


## Methodology

We work towards our goal through asking and answering several sub-questions. The following section contains the analysis for answering the following questions:
  -	How does the total number of reported infections in the Netherlands as a whole develop over time?
  -	What does this trend look like displayed per 100,000 inhabitants of the Netherlands?
  -	What is the mean level of RNA particles found in the water per 100,000 inhabitants?
  -	What is the relationship between RNA particles and the total number of infections on one given moment?
  -	How does this relationship look over time?

### 1. How does the total number of reported infections in the Netherlands as a whole develop over time? 

In order to answer this question we need a function that calculates the number of total reported infections per day. We wrote a function to aggregate the data by the number of reported infections in a municipality on a given day to the total number of reported infections on that day in the Netherlands as a whole, discarding double entries per municipality. The resulting output is visualized in the figure below, where you can see the total number of reported infections we have had over time in the Netherlands. The second wave is also clearly visible, where you see the total number of reported infections increasing more rapidly in October compared to September. 

```{r}
#create dataframe with only the observations from 7th of September onward
all_dates <- unique(dat$newdate) #243 recorded dates, starting March 13th
used_dates <- dat %>% filter(newdate %in% all_dates[-c(1:178)]) #dates from 7th of Sept

#this function calculates the total of reported cases on one day, across all municipalities:
totalCalculator <- function(sewer_data) {
  dates <- unique(sewer_data$newdate) #create a list of unique dates in the dataset 
  totals <- numeric(length(dates)) #make an object with the length of the number of dates
  
  #subtract nr of reported cases of the day before each day to get the difference
  for (i in 1:(length(totals))) {
    step1 <- filter(sewer_data, newdate == dates[i]) #select date we want to calculate the nr of new cases for
    
    #create data frame of the  dates, and remove duplicates (total reported per municipalities are the same across duplicates)
    df <- step1[!duplicated(step1[,"MN_name"]),] 
    
    #calculate the sum of all new reported cases per municipality and store in object
    sums <- sum(df$MN_total.reported, na.rm = TRUE)
    totals[i] <- sums
  }
  
  #create a data frame with all the outcomes, matched with each date
  totals_frame <- as.data.frame(cbind(dates, totals))
  colnames(totals_frame) <- c("Date", "Total number of reported infections") #rename columns
  totals_frame$`Total number of reported infections` <- as.numeric(totals_frame$`Total number of reported infections`) #store the totals as numeric values.
  
  #create a plot of the totals over time
  plot <- barplot(totals_frame$`Total number of reported infections`, 
                  main = "Total number of reported infections per day", 
                  xlab = "Date", 
                  ylab = "Total number of reported infections", 
                  ylim = c(0,350000), 
                  names.arg = as.Date(dates),
                  col = 'greenyellow')
  
  #Output a data frame with the total of new cases per day
  output = list(totals_frame, plot)
  return(output)
}

totalCalculator(used_dates)

```


We are also interested in the daily fluctuations of the number of reported infections in the Netherlands. To show this, we altered the function such that it would calculate the difference in total reported cases between each day and the day before. The results are visualized in the following figure. We see that the peak of new infections in the second wave is somewhere in the end of October, as we would expect from the previous figure.  

```{r}
#this function calculates the difference in reported cases between one day and the day before that:
differenceCalculator <- function(sewer_data) {
  dates <- unique(sewer_data$newdate) #create a list of unique dates in the dataset
  differences <- numeric(length(dates)-1) #make an object with the length of one fewer than the number of        dates. Why one fewer? We cannot calculate the number of new reported cases of the first day, because the number of cases from the preceding day is unknown.  
  
  #subtract nr of reported cases of the day before each day to get the difference
  for (i in 1:(length(differences))) {
    step1 <- filter(sewer_data, newdate == dates[i]) #select date of reference
    step2 <- filter(sewer_data, newdate == dates[i+1]) #select date we want to calculate the number of new cases for
    
    #create data frames of both sets of dates, and remove duplicates (total reported per municipalities are the same across duplicates)
    df1 <- step1[!duplicated(step1[,"MN_name"]),] 
    df2 <- step2[!duplicated(step2[,"MN_name"]),]
    
    #calculate the difference between the two dataframes for each set of dates and store in object
    diff <- (sum(df2$MN_total.reported, na.rm = TRUE) - sum(df1$MN_total.reported, na.rm = TRUE))
    differences[i] <- diff
  }
  
  #create a data frame with all the outcomes, matched with each date
  diff_frame <- as.data.frame(cbind(dates[-1], differences))
  colnames(diff_frame) <- c("Date", "Difference in reported infections") #rename columns
  diff_frame$`Difference in reported infections` <- as.numeric(diff_frame$`Difference in reported infections`) #store the differences as numeric values.
  
  
  #create a plot of the totals over time
  plot <- barplot(diff_frame$`Difference in reported infections`, 
                  main = "Difference in reported infections compared to the previous day", 
                  xlab = "Date", 
                  ylab = "Difference in reported infections", 
                  names.arg = as.Date(dates[-1]), 
                  col = 'greenyellow')
  
  #output a data frame with new cases per day
  output = list(diff_frame, plot)
  return(output)
}

differenceCalculator(used_dates)
```

### 2. What does this trend look like displayed per 100,000 inhabitants of the Netherlands?

Next, we visualized the number of reported cases per 100,000 inhabitants of the Netherlands. Again, we decided to do this for both the total number of infections we have had over time, as well as the daily differences. As you can see in the figures below, the shape of the distribution is the same, but the scale on the y-axis is different. This is expected, as we took the functions of the previous step and multiplied the total number of reported infections by the number of inhabitants of the municipality divided by 100,000.

```{r}
#in the data preparation, we already multiplied the municipality population by 1000,
#so no need to do that again.
#however, we do need make a new variable containing the number of cases per 100.000 people
#to do that, we multiple the total number of reported cases by 100.000 divided by the municipality population and give it an informative name.
used_dates$cases_per_100000 <- used_dates$MN_total.reported * (100000/used_dates$MN_pop)

#make a function that calculates the mean number of infection per 100.000 inhabitants per day.
#so, this is over the Netherlands as a whole.
totalCalculator2 <- function(used_dates) {
  dates <- unique(used_dates$newdate) #create a list of dates
  totals <- numeric(length(dates)-1) #make an object with the length of one fewer than the number of dates. Why one fewer? We cannot calculate the number of new reported cases of the first day, because the number of cases from the preceding day is unknown.
  
  for (i in 1:(length(totals))) {
        step1 <- filter(used_dates, newdate == dates[i]) #select the date we want to calculate the nr of cases per 100.000 inhabitants for
    
    #create data frame of the  dates, and remove duplicates (total reported per municipalities are the same across duplicates)
    df <- step1[!duplicated(step1[,"MN_name"]),] 
    
    #calculate the mean number of reported cases per 100.000 inhabitants in the Netherlands and store in object
    means <- mean(df$cases_per_100000, na.rm = TRUE)
    totals[i] <- means #give it a name
  }
  
  #create a dataframe with the totals by the respecitve dates
  tot_frame <- as.data.frame(cbind(dates[-1], totals))
  #give the columns informative names
  colnames(tot_frame) <- c("Date", "Reported infections per 100.000")
  #and make the increase numeric
  tot_frame$`Reported infections per 100.000` <- as.numeric(tot_frame$`Reported infections per 100.000`)
  
   #create a plot of the increase per 100.000 inhabitants over time
   barplot(tot_frame$`Reported infections per 100.000`, 
                  main = "Mean number of reported infections per 100.000 inhabitants over time", 
                  xlab = "Date", 
                  ylab = "Mean number of reported infections per 100.000 inhabitants", 
                  names.arg = as.Date(dates[-1]),
                  col = 'greenyellow')

  return(tot_frame)
}

totalCalculator2(used_dates)
```

```{r}
#in the data preparation, we already multplied the municipality population by 1000,
#so no need to do that again.
#however, we do need make a new variable containing the number of cases per 100.000 people
#to do that, we multiple the total number of reported cases by 100.000 divided by the municipality population and give it an informative name.
used_dates$cases_per_100000 <- used_dates$MN_total.reported * (100000/used_dates$MN_pop)

#make a function that calculates the mean number of infection per 100.000 inhabitants per day.
#so, this is over the Netherlands as a whole.
differenceCalculator2 <- function(used_dates) {
  dates <- unique(used_dates$newdate) #create a list of dates
  differences <- numeric(length(dates)-1) #make an object with the length of one fewer than the number of dates. Why one fewer? We cannot calculate the number of new reported cases of the first day, because the number of cases from the preceding day is unknown.
  for (i in 1:(length(differences))) {
    step1 <- filter(used_dates, newdate == dates[i]) #select date of reference
    step2 <- filter(used_dates, newdate == dates[i+1]) #select date we want to calculate the nr of new cases for
    
    #create data frames of both sets of dates, and remove duplicates (total reported per municipalities are the same across duplicates)
    df1 <- step1[!duplicated(step1[,"MN_name"]),]
    df2 <- step2[!duplicated(step2[,"MN_name"]),]
    
    #calculate the differences by subtracting the previous day from the one the for loop is on then
    diff <- (mean(df2$cases_per_100000, na.rm = TRUE) - mean(df1$cases_per_100000, na.rm = TRUE))
    #and store it in our differences vector
    differences[i] <- diff
  }
  
  #create a dataframe with the differences by the respecitve dates
  diff_frame <- as.data.frame(cbind(dates[-1], differences))
  #give the columns informative names
  colnames(diff_frame) <- c("Date", "Increase in reported infections per 100.000")
  #and make the increase numeric
  diff_frame$`Increase in reported infections per 100.000` <- as.numeric(diff_frame$`Increase in reported infections per 100.000`)
  
   #create a plot of the increase per 100.000 inhabitants over time
   barplot(diff_frame$`Increase in reported infections per 100.000`, 
                  main = "Difference in reported infections per 100.000 inhabitants", 
                  xlab = "Date", 
                  ylab = "Difference in reported infections per 100.000 inhabitants", 
                  names.arg = as.Date(dates[-1]),
                  col = 'greenyellow')

  return(diff_frame)
}

differenceCalculator2(used_dates)
```

### 3. What is the mean level of RNA particles found in the water per 100,000 inhabitants? 

We saw that the number of infections had been increasing since the beginning of September and peaked in October. As one only requests a test after experiencing symptoms, one would expect the amount of RNA particles in the sewage water to precede the increase in the number of infections. Therefore, we have visualized the distribution of the RNA particles in the Netherlands over time. In the figure below, the mean number of RNA particles per 100,000 inhabitants summed over all sewage water installations for every day is plotted. The shape of the plot loosely follows the same trend as the plot of the reported infections, but its shape is much less smooth. 

```{r}

used_dates$TP_RNA.flow.per.100000 <- as.numeric(used_dates$TP_RNA.flow.per.100000)

virusCalculator_new <- function(used_dates) {
  #creates a vector containing the unique values of the dates column of data. So vector with dates from September the seventh
  #till October the tenth
  dates <- unique(used_dates$newdate)
  #makes an empty numeric vector which length is equal to number of dates
  means <- numeric(length(dates))
  for (i in 1:length(means)) {
    #puts all the data of a particular date into date_data. the particular date changes at each iteration.
    date_data <- filter(used_dates, newdate == dates[i])
    #delete rows if the water installation name is already in other row.
    df1 <- date_data[!duplicated(date_data[,c("SR_name","TP_code")]),]
    #take the mean of the rna per 100000 column and store in means vector
    means[i] <- mean(df1$TP_RNA.flow.per.100000, na.rm = TRUE)
  }
  #put date and means vector in dataframe.
  means_frame <- as.data.frame(cbind(dates, means))
  #define column names.
  colnames(means_frame) <- c("Date", "Mean RNA flow per 100000")
  #coerce the column into double precision vector.
  means_frame$`Mean RNA flow per 100000` <- as.double(means_frame$`Mean RNA flow per 100000`)
  #create a barplot 
  barplot(means_frame$`Mean RNA flow per 100000`, 
          col='greenyellow', 
          main = 'Mean RNA flow per 100,000 per day', 
          xlab = 'Date', 
          ylab = 'Mean RNA flow per 100,000', 
          names.arg = dates)
  return(means_frame)
}

data_frame2 <- virusCalculator_new(used_dates)
```
The reason for the different shapes of the plot showing the mean RNA flow and the plot showing the increase in infections could be the fact that not all treatment plants report the RNA flow every day, and that the number of reporting treatment plants differs per day and per region. In order to explore this idea we plotted the number of installations from which a sample was taken over time. The figure below shows that the number of installations from which a sample is taken differs per day. The figure also shows that the maximal number of sewage water installations from which samples are taken lies somewhere around one hundred. Since there are more than three hundred installations from which a sample can be taken (RIVM, 2020), there is not a single day where a sample is taken from all installations. So every day samples are taken from different installations that process waste water from different regions. If every region produced the same amount of RNA particles it would not matter that we do not observe each installation each day. Since we take the mean of the amount of RNA particles, the estimate would not be harmed by a missing installation. However, the figure that shows the mean number of RNA particles observed each day suggests that the estimate of the mean number of RNA particles is not correct. If it were correct, then the values would not fluctuate as much as they do now and would follow the trend of new infections more clearly. Thus, the plot supports our claim that the different shapes of the plot showing the mean RNA flow and the plot showing the increase in infections could be explained by the fact that not all treatment plants report the RNA flow every day, and that the number of reporting treatment plants differs per day and per region.

```{r}
totalCalculator_installations <- function(sewer_data) {
  dates <- unique(sewer_data$newdate) #create a list of unique dates in the data set 
  totals <- numeric(length(dates)) #make an object with the length of the number of dates
  
  #subtract number of reported cases of the day before each day to get the difference
  for (i in 1:(length(totals))) {
    step1 <- filter(sewer_data, newdate == dates[i]) #select date we want to calculate the nr of new cases for
    
    #create data frame of the  dates, and remove duplicates (of installations)
    df <- step1[!duplicated(step1[,"TP_code"]),]
    codes<-df$TP_code[!is.na(df$TP_code)]
    #calculate the number of installations per day
    sums <- length(codes)
    totals[i] <- sums
  }
  barplot(totals, 
          col = 'greenyellow', 
          names.arg = dates, 
          main = 'Number of installations per day',
          ylab = 'Date', 
          xlab = 'Number')
  
}
totalCalculator_installations(used_dates)
```

### 4. What is the relationship between RNA particles and the total number of infections on one given moment? 

As mentioned in the data description, some installations process water from multiple security regions, rendering the current RNA flow variable unrepresentative. We do have a variable available that contains the proportion of water from the security region processed by that respective installation. We multiplied these two columns to create a representative RNA flow variable.

Now that the RNA flow has been weighted, we want to inspect how the RNA flow is related to the increase in the number of infections on the level of the security regions. To achieve this, we altered the current functions for calculating the RNA flow and increase in number of infections per day so that these values are reported for each security region per day. Subsequently, we compared the RNA flow from one day to the increase in the number of reported infections from seven days later. The reason for this is that there is generally a seven-day time lag between a person contracting COVID – leaving RNA particles in the sewage water – and getting a positive test (Peccia et al., 2020). A scatterplot with the aforementioned data should provide a first impression of how they are related to each other. Since not every security region has data about the RNA flow on any given day and data about the increase in the number of infections seven days later, only security regions that have data for both days are selected. Subsequently, the correlation for those data is calculated.



### FOR OUR GROUP: I'VE REMOVED ALL NA ROWS FOR NOW. THIS WOULD HAVE ALSO BEEN DONE IF NA.RM HAD BEEN IMPLEMENTED IN CALCULATING THE MEAN

```{r}
rnaWeighting <- function(used_dates) {
  dates <- unique(used_dates$newdate) #create a list of all dates
  adjusted_means <- numeric(length(dates)) #create a vector of zeros that is equal in length to the number of dates
  
  non_na_data <- used_dates[!is.na(used_dates$TP_RNA.flow.per.100000),] #just for now eliminate NA rows
  non_na_data2 <- non_na_data[!is.na(non_na_data$TP_percentage.in.SR),]
  non_na_data2$TP_percentage.in.SR <- as.double(non_na_data2$TP_percentage.in.SR)
  non_na_data2$adjusted_RNA_flow <- (non_na_data2$TP_RNA.flow.per.100000 *    non_na_data2$TP_percentage.in.SR) #adjust rna flow by multiplying it with the proportion of water from that security region processed by that RWZI
  
  for (i in 1:length(adjusted_means)) {
    day_data <- filter(non_na_data2, newdate == dates[i])
    df1 <- day_data[!duplicated(day_data[,c("SR_name","TP_code")]),]
    
    
    adjusted_means[i] <- mean(df1$adjusted_RNA_flow, na.rm = TRUE)
  }
  means_frame <- as.data.frame(cbind(dates, adjusted_means))
  colnames(means_frame) <- c("Date", "Adjusted mean RNA flow per 100000")
  means_frame$`Adjusted mean RNA flow per 100000` <- as.double(means_frame$`Adjusted mean RNA flow per 100000`)
  
     #create a plot of the increase per 100.000 inhabitants over time
   barplot(means_frame$`Adjusted mean RNA flow per 100000`, 
                  main = "RNA flow per 100.000 inhabitants in The Netherlands over time", 
                  xlab = "Date", 
                  ylab = "RNA flow per 100.000 inhabitants", 
                  names.arg = as.Date(dates))
  
  return(means_frame)
}

data_frame2 <- rnaWeighting(used_dates)

mean(data_frame2$`Adjusted mean RNA flow per 100000`, na.rm = TRUE)

#rnaWeighting2 <- function(used_dates) {
#  dates <- unique(used_dates$newdate) #create a list of all dates
#  adjusted_means <- numeric(length(dates)-1) #create a vector of zeros that is equal in length to the number of dates
  
#  non_na_data <- used_dates[!is.na(used_dates$TP_RNA.flow.per.100000),] #just for now eliminate NA rows
#  non_na_data2 <- non_na_data[!is.na(non_na_data$TP_percentage.in.SR),]
#  non_na_data2$TP_percentage.in.SR <- as.double(non_na_data2$TP_percentage.in.SR)
#  non_na_data2$adjusted_RNA_flow <- (non_na_data2$TP_RNA.flow.per.100000 *    non_na_data2$TP_percentage.in.SR) #adjust rna flow by multiplying it with the proportion of water from that security region processed by that RWZI
  
#  sr_frame <- data.frame()
#  for (i in 1:length(adjusted_means)) {
#    day_data <- filter(non_na_data2, newdate == dates[1])
#    day_data2 <- filter(non_na_data2, newdate == dates[2])
#    df1 <- day_data[!duplicated(day_data[,c("SR_name","TP_code")]),]
    
#    df2 <- day_data[!duplicated(day_data[,c("SR_name","MN_name")]),]
#    df2_2 <- day_data2[!duplicated(day_data[,c("SR_name","MN_name")]),]
    
#    reported_total <- tapply(df2_2$MN_total.reported, list(Municipalities = df2_2$SR_name), sum) - tapply(df2$MN_total.reported, list(Municipalities = df2$SR_name), sum)
    
#    regions <- unique(df1$SR_name)
#    rna_totals <- tapply(df1$adjusted_RNA_flow, list(Regions = df1$SR_name), sum, na.rm = TRUE)
#    day_frame <- data.frame(Date = rep(dates[i], length(rna_totals)), Region = regions, RNA_total = rna_totals, Reported_total = reported_total)
#    sr_frame <- rbind(sr_frame, day_frame)
#  }
  
     #create a plot of the increase per 100.000 inhabitants over time
#  day_totals <- tapply(sr_frame$RNA_total, list(Dates = sr_frame$Date), sum)
#   barplot(day_totals, 
#                  main = "RNA flow per 100.000 inhabitants in The Netherlands over time", 
#                  xlab = "Date", 
#                  ylab = "RNA flow per 100.000 inhabitants")
  
#  return(sr_frame)
#}

#data_frame3 <- rnaWeighting2(used_dates)
#data_frame3$Region <- rownames(data_frame3)
#rownames(data_frame3) <- NULL
#data_frame3

newCalculator <- function(used_dates) {
  sr_frame <- data.frame()
  dates <- unique(used_dates$newdate) #extract a vector of dates
  regions <- unique(used_dates$SR_name) #extract a vector of all security regions
  used_dates$adjusted_RNA_flow <- (used_dates$TP_RNA.flow.per.100000 *  used_dates$TP_percentage.in.SR)
  
  for (i in 1:(length(dates)-1)) {
    step1 <- filter(used_dates, newdate == dates[i]) #filter the data for date 1
    step2 <- filter(used_dates, newdate == dates[i+1]) #filter the data for the day after the current day
  
    for (j in 1:length(regions)) {
      r1_data <- filter(step1, SR_name == regions[j]) #filter all data for a given region on the first day
      r2_data <- filter(step2, SR_name == regions[j]) #filter all data for a given region on the second day
    
      df1 <- r1_data[!duplicated(r1_data[,"MN_name"]),] #delete all duplicate municipality rows
      df2 <- r2_data[!duplicated(r2_data[,"MN_name"]),] #delete all duplicate municipality rows on the second day
    
      increase <- sum(df2$MN_total.reported, na.rm = TRUE) - sum(df1$MN_total.reported, na.rm = TRUE)
      rna_flow <- sum(r2_data$adjusted_RNA_flow)
      r_frame <- data.frame(Date = dates[i+1], Region = regions[j], Increase = increase, RNA.flow = rna_flow)
      sr_frame <- rbind(sr_frame, r_frame)
    }
  }
  non_na_frame <- sr_frame[complete.cases(sr_frame),]
  return(non_na_frame)
}

good_frame <- newCalculator(used_dates)
good_frame
```

Figure 5 shows the correlation between the RNA flow on the 8th of September and the increase in the number of infections on the 15th of September. As can been seen from the scatterplot, these data do not seem be strongly related to each other. Additionally, the correlation associated with this scatterplot is 0.027, which indicates that these data almost show no relationship to each other. This strikes us as very surprising, since one would expect a relationship between the RNA flow and the increase in the number of infections. In the next step, we extend the analysis conducted over the period of September until November to see if this trend persists.


### 5. How does this relationship look over time? 

We calculated the correlation between the RNA flow on the first day and the increase in infections seven days later for each available combination of days (i.e. available combination of one date and the date seven days later). Finally, we plotted all the correlations over the period in a scatterplot.

```{r}
sumRNAcalculator <- function(used_dates, date) {
  dates <- unique(used_dates$newdate) #create a list of dates
  means <- numeric(length(dates))
  step1 <- filter(used_dates, newdate == date)

  step1$MN_name <- as.factor(step1$MN_name)
  sum_rna_flows <- tapply(step1$TP_RNA.flow.per.100000, list(Municaplities = step1$MN_name), sum, na.rm = TRUE)

  return(sum_rna_flows)
}

totalReported <- function(used_dates, date) {
  step1 <- filter(used_dates, newdate == date)
  df1 <- step1[!duplicated(step1[,"MN_name"]),c(3,7)]
  
  return(df1)
}

differenceCalculator3 <- function(used_dates) {
  dates <- unique(used_dates$newdate) #create a list of dates
  cors <- numeric(length(dates)-7) #create a vector of zeros equal in length to the number of dates - 1 because we calculate differences
  cor_frame <- data.frame()
  
  for (i in 1:(length(cors))) {
    step1 <- filter(used_dates, newdate == dates[1]) #filter data from first day, e.g. 2020-09-07
    step2 <- filter(used_dates, newdate == dates[2]) #filter data from second day, e.g. 2020-09-08
    
    df1 <- step1[!duplicated(step1[,"MN_name"]),] #remove duplicate rows for total reported
    df2 <- step2[!duplicated(step2[,"MN_name"]),] #remove duplicate rows for total reported
    
    df1$MN_name <- as.factor(df1$MN_name) 
    step1$MN_name <- as.factor(step1$MN_name)
    step2$MN_name <- as.factor(step2$MN_name)
    ind1 <- sort.list(df1$MN_name)
    ind2 <- sort.list(df2$MN_name)
    
    diff_infections <- df2[ind2,]$MN_total.reported - df1[ind1,]$MN_total.reported #calculate difference in infections for each municipality
    
    diff_rna <- tapply(step2$TP_RNA.flow.per.100000, list(Municipalities = step2$MN_name), sum, na.rm = TRUE) - tapply(step1$TP_RNA.flow.per.100000, list(Municipalities = step1$MN_name), sum, na.rm = TRUE) #calculate difference in total rna flow for each municipality
    
    new_frame = data.frame(rep(dates[i+1], 344), df1$MN_name, diff_infections, diff_rna)
    colnames(new_frame) <- c("Date", "Municipality", "Change in infections", "Change in RNA")
    cor_frame <- rbind(cor_frame, new_frame)
  }

  return(cor_frame)
}

cor_frame <- differenceCalculator3(used_dates)
cor_frame$Municipality <- rownames(cor_frame)

means1day <- sumRNAcalculator(used_dates, "2020-09-07")
means1day[means1day == "NaN"] <- 0
means1day

infections <- totalReported(used_dates, "2020-09-14")
cor(means1day, infections$MN_total.reported)


means2day <- sumRNAcalculator(used_dates, "2020-10-20")
means2day[means1day == "NaN"] <- 0

infections2 <- totalReported(used_dates, "2020-10-27")
cor(means2day, infections2$MN_total.reported)

Utrecht <- used_dates[which(used_dates$MN_name=='Utrecht'), ]
Utrecht2 <- Utrecht[which(!is.na(Utrecht$TP_RNA.flow.per.100000)), ]

with(Utrecht2, cor(MN_total.reported, TP_RNA.flow.per.100000))
plot(Utrecht2$MN_total.reported, Utrecht2$TP_RNA.flow.per.100000)

#sumRNAcalculator(Utrecht)
```

```{r}
sumRNAcalculator <- function(used_dates) {
  dates <- unique(used_dates$newdate) #create a list of dates
  sum_rna_flows <- numeric(length(dates))
  
  for (i in 1:length(sum_rna_flows)) {
  step1 <- filter(used_dates, newdate == dates[i])
  sum_rna_flows[i] <- sum(step1$TP_RNA.flow.per.100000, na.rm = TRUE)
  
  }

  sum_frame <- as.data.frame(cbind(dates, sum_rna_flows))
  colnames(sum_frame) <- c("Date", "sum_RNA")
  sum_frame$`sum_RNA` <- as.double(sum_frame$`sum_RNA`)
  
  return(sum_frame)
}

meanReportedcalculator <- function(used_dates) {
  dates <- unique(used_dates$newdate) #create a list of dates
  mean_reported <- numeric(length(dates))
  
  for (i in 1:length(mean_reported )) {
  step1 <- filter(used_dates, newdate == dates[i])
  mean_reported [i] <- mean(step1$MN_total.reported, na.rm = TRUE)
  
  }

  mean_frame <- as.data.frame(mean_reported)
  colnames(mean_frame) <- c("total_reported")
  mean_frame$`total_reported` <- as.double(mean_frame$`total_reported`)
  
  return(mean_frame)
}

Utrecht3 <- sumRNAcalculator(Utrecht2)
Utrecht4 <- meanReportedcalculator(Utrecht2)
Utrecht5 <- cbind(Utrecht3, Utrecht4)
cor(Utrecht5$total_reported, Utrecht5$sum_RNA)
plot(Utrecht5$total_reported, Utrecht5$sum_RNA)
abline(lm(total_reported ~ sum_RNA, data = Utrecht5))
```

#New Step 5?: Relationship between RNA flow and increase in infections for one day

```{r}
good_dates <- unique(good_frame$Date) #extract a list of the dates in the dataframe
day1 <- filter(good_frame, Date == good_dates[1]) #extract the data of the first day, i.e. 8th of september
day2 <- filter(good_frame, Date == good_dates[8]) #extract the data of increase in infections 7 days later, i.e. 15th of september
regions <- unique(used_dates$SR_name)
day_frame <- data.frame()
for (i in 1:(length(regions))) {
  dat1 <- filter(day1, Region == regions[i])
  dat2 <- filter(day2, Region == regions[i])
  if (nrow(dat1) == 1 && nrow(dat2) == 1) {
    d_frame <- data.frame(Region = regions[i], Reported = dat2$Increase, RNA.flow = dat1$RNA.flow)
    day_frame <- rbind(day_frame, d_frame)
  }
}

plot(day_frame$RNA.flow, day_frame$Reported, col = "red", pch = 19, xlab = "RNA flow", ylab = "Increase in number of infections"); abline(lm(Reported ~ RNA.flow, data = day_frame), lwd = 2)
cor(x= day_frame$RNA.flow, y = day_frame$Reported)
```

#Step 6: Correlations over the period 8th of September till 10th of november
```{r}
corCalculator <- function(good_frame, used_dates) {
  dates <- unique(good_frame$Date)
  regions <- unique(used_dates$SR_name)
  cor_frame <- data.frame()
  
  for (i in 1:(length(dates)-7)) {
    day1 <- filter(good_frame, Date == dates[i]) #filter data for the first day
    day2 <- filter(good_frame, Date == dates[i+7]) #filter data for 7 days later
    day_frame <- data.frame()
    observations <- 0
  
    for (j in 1:length(regions)) {
      dat1 <- filter(day1, Region == regions[j])
      dat2 <- filter(day2, Region == regions[j])
      if (nrow(dat1) == 1 && nrow(dat2) == 1) {
        observations <- observations + 1
        d_frame <- data.frame(Region = regions[j], Reported = dat2$Increase, RNA.flow = dat1$RNA.flow)
        day_frame <- rbind(day_frame, d_frame)
      } else {
        next
      }
    }
    cor_f <- data.frame(Date = dates[i+7], Correlation = cor(day_frame$Reported, day_frame$RNA.flow), Observations = observations)
    cor_frame <- rbind(cor_frame, cor_f)
  }
  return(cor_frame)
}

correlation_frame <- corCalculator(good_frame, used_dates)
correlation_frame
mean(correlation_frame$Correlation, na.rm = TRUE)

corr_frame <- correlation_frame[complete.cases(correlation_frame),]
corr_frame$Date <- as.Date(corr_frame$Date)
plot(x = corr_frame$Date, y = corr_frame$Correlation, col = "red", pch = 19, xlab = "Date", ylab = "Correlation"); abline(lm(Correlation ~ Date, data = corr_frame), lwd = 2)
```

Figure 6 shows that the correlations fluctuate over time, which seems very interesting. If the data points would have formed a straight horizontal line, the estimation of the true number of infections in the Netherlands would have been more straightforward, since it would mean that the relationship between the RNA flow and the increase in infections would have been the same for every day. The mean correlation between the datapoints in this scatterplot is 0.33, which is a moderate positive correlation. This means that as the pandemic progresses, the relationship between the RNA flow and the increase in the number of infections becomes stronger. We have two hypotheses as to why this would be the case: it could be a result of increased consistency and precision in the measurements as we get more rigorous in reporting these data, or – as the number of cases has only increased over the period we analysed – it could mean that RNA flow becomes a better predictor of the total number of reported cases, as both measures have higher values. 

# Preliminary conclusions
As of yet, we are unable to make a reliable estimate of the true number of infected people in the Netherlands. First and foremost, this is due to the unstable nature of the correlation between the RNA flow and the total number of recorded infections. However, the moderate, positive correlation between these two variables indicates that the RNA flow becomes an increasingly better predictor as we get further along in the pandemic. If we do essay to construct a prediction model, we recommend to use only the most recent RNA flow data to build it, as they are likely the most reliable. 

Our next line of investigation will be to try to combine the RNA flow as a predictor with other available variables in our dataset, such as population density. We would also like to separate this analysis by security region, to isolate the effect of geographic location on the predictor. 

If we had infinite time and resources, we would like to enrich our analysis by incorporating other types of data in our analysis. For example, we could use behavioural data on when people are more or less likely to get tested when displaying symptoms, to improve the estimate of the true number of infected people. Another option would be to include environmental data on how much rain fell in each region on each day, to correct for the influence this might have on the concentration of RNA particles in the sewage water. For now, we conclude that the RNA flow is an imperfect indicator of the true number of infected people in the Netherlands, but that it could potentially be very valuable in combination with other data sources. 


# Discussion

# References
Pan, Y., Zhang, D., Yang, P., Poon, L. L. M. & Wang, Q. Viral load of SARSCoV-2 in clinical samples. The Lancet. Infectious diseases 20, 411-412, doi:10.1016/s1473-3099(20)30113-4 (2020).

Peccia, J., Zulli, A., Brackney, D.E. et al. Measurement of SARS-CoV-2 RNA in wastewater tracks community infection dynamics. Nat Biotechnol 38, 1164–1167 (2020). https://doi.org/10.1038/s41587-020-0684-z

RIVM. (2020) Covid-19 aantallen per gemeente per publicatiedatum [Data file]. Retrieved on the 10th of November 2020 from: https://data.rivm.nl/geonetwork/srv/dut/catalog.search#/metadata/5f6bc429-1596-490e-8618-1ed8fd768427 

RIVM. (2020) Covid-19 Nationale SARS-CoV-2 Afvalwatersurveillance [Data file]. Retrieved on the 10th of November 2020 from: https://data.rivm.nl/geonetwork/srv/dut/catalog.search#/metadata/a2960b68-9d3f-4dc3-9485-600570cd52b9?tab=general

RIVM. (2020, November 2). Rioolwateronderzoek. Retrieved from https://www.rivm.nl/coronavirus-covid-19/onderzoek/rioolwater

Vallejo, J. A., Rumbo-Feal, S., Conde-Pérez, K., López-Oriona, Á., Tarrío, J., Reif, R., ... & Veiga, M. C. (2020). Highly predictive regression model of active cases of COVID-19 in a population by screening wastewater viral load. medRxiv.


```{r waste bin}
#because of this:
#multiply by 1000 to get rid of the "." in the population variable
#dat <- dat %>% mutate(MN_pop = MN_pop*1000)
#I think this line in step 2 is double, so I removed it and put it here
used_dates$MN_pop <- used_dates$MN_pop * 1000

```
